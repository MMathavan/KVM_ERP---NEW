@model KVM_ERP.Models.TransactionMaster
@{
    ViewBag.Title = "Opening Stock - Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var materialGroups = ViewBag.MaterialGroups as List<System.Web.Mvc.SelectListItem> ?? new List<System.Web.Mvc.SelectListItem>();
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .main-container { background: white; min-height: 100vh; padding: 20px 0; }
    .form-container { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,.1); margin: 20px; overflow: hidden; border: 1px solid #e9ecef; }
    .form-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px 30px; border-radius: 15px 15px 0 0; }
    .form-title { font-size: 28px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 15px; }
    .form-body { padding: 30px; background: white; }
    .form-group { margin-bottom: 18px; }
    .control-label { font-weight: 600; color: #2d3436; margin-bottom: 8px; display: block; }
    .form-control { border: 2px solid #e9ecef; border-radius: 8px; padding: 10px 12px; font-size: 14px; background: #f8f9fa; }
    .form-control:focus { border-color: #4facfe; box-shadow: 0 0 0 0.2rem rgba(79,172,254,.25); background: white; }

    .select2-container { width: 100% !important; }
    .select2-container--default .select2-selection--single {
        height: 42px; border: 2px solid #e9ecef; border-radius: 8px; background: #f8f9fa;
        display: flex; align-items: center; padding: 0 12px; transition: all 0.3s ease;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 38px; font-size: 14px; padding-left: 0;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 38px; right: 10px; }

    .table-section { margin-top: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
    .table-section-title { margin-bottom: 15px; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 10px; }

    .slab-table-wrapper { overflow-x: auto; }
    .slab-table { border-collapse: collapse; width: 100%; font-size: 12px; }
    .slab-table thead th {
        background: #7f88e9; color: #fff; padding: 8px; border: 1px solid #6c75d3; text-align: center; white-space: nowrap;
    }
    .slab-table tbody td { padding: 6px; border: 1px solid #dee2e6; text-align: center; }
    .slab-table tbody tr.total-row { background: #d4edda; font-weight: 600; }
    .slab-table tbody tr.no-of-cases-row { background: #fff3cd; font-weight: 600; }
    .slab-table tbody td.particulars-cell { text-align: left; font-weight: 600; }
    .slab-input {
        width: 100%;
        box-sizing: border-box;
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        text-align: right;
    }
</style>

<div class="main-container">
    <div class="form-container">
        <div class="form-header">
            <h1 class="form-title">
                <i class="fa fa-play-circle"></i>
                Opening Stock
            </h1>
        </div>
        <div class="form-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">As on Date <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.TRANDATE, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "asOnDate", required = "required" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Product Type <span class="text-danger">*</span></label>
                        @Html.DropDownList("ProductTypeId", materialGroups, "-- Select Product Type --", new { @class = "form-control select2", id = "productType" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Product <span class="text-danger">*</span></label>
                        <select id="product" class="form-control select2">
                            <option value="">-- Select Product --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Packing <span class="text-danger">*</span></label>
                        <select id="packing" class="form-control select2">
                            <option value="">-- Select Packing --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-section">
                <div class="table-section-title">
                    <i class="fa fa-table"></i> Opening Stock Slab Details
                </div>
                <div id="slabTableContainer">
                    <p class="text-muted">Select As on Date, Product Type, Product and Packing to view slab-wise opening stock.</p>
                </div>
            </div>

            <div class="form-group text-center" style="margin-top: 25px;">
                <a href="@Url.Action("Index", "OpeningStock")" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.select2').select2({
                placeholder: '-- Select --',
                allowClear: true,
                width: '100%'
            });

            $('#productType').on('change', function () {
                var groupId = $(this).val();
                $('#product').empty().append('<option value="">-- Select Product --</option>');
                $('#packing').empty().append('<option value="">-- Select Packing --</option>');
                if (!groupId) {
                    return;
                }

                $.getJSON('@Url.Action("GetProducts", "OpeningStock")', { groupId: groupId })
                    .done(function (list) {
                        $.each(list, function (_, item) {
                            $('#product').append('<option value="' + item.id + '">' + item.text + '</option>');
                        });
                        $('#product').trigger('change.select2');
                    });

                $.getJSON('@Url.Action("GetPackingMasters", "OpeningStock")', { groupId: groupId })
                    .done(function (list) {
                        $.each(list, function (_, item) {
                            $('#packing').append('<option value="' + item.id + '">' + item.text + '</option>');
                        });
                        $('#packing').trigger('change.select2');
                    });
            });

            function tryRenderTable() {
                var asOn = $('#asOnDate').val();
                var productId = $('#product').val();
                var packingId = $('#packing').val();

                if (!asOn || !productId || !packingId) {
                    $('#slabTableContainer').html('<p class="text-muted">Select As on Date, Product Type, Product and Packing to view slab-wise opening stock.</p>');
                    return;
                }

                // Reuse StockView breakdown logic for a single product/packing as on As on Date
                $.ajax({
                    url: '@Url.Action("GetItemDetails", "StockView")',
                    type: 'POST',
                    data: {
                        itemId: productId,
                        asOnDate: asOn,
                        calculationMode: null,
                        packingId: packingId
                    },
                    success: function (response) {
                        if (response && response.success && response.packingMasters && response.packingMasters.length > 0) {
                            // When packingId is supplied, StockView already filters to the
                            // matching packing master, so the first (and typically only)
                            // entry is the one we need.
                            var selectedPm = response.packingMasters[0];

                            // Use the selectedDate value returned by StockView so our Inward row
                            // matches exactly the date grouping used there.
                            var selectedDateKey = response.selectedDate || asOn;
                            renderSlabTable(selectedPm, selectedDateKey);
                        } else {
                            $('#slabTableContainer').html('<p class="text-muted">No slab data available for selected combination.</p>');
                        }
                    },
                    error: function () {
                        $('#slabTableContainer').html('<p class="text-danger">Error loading slab data.</p>');
                    }
                });
            }

            function renderSlabTable(packingMaster, selectedDateKey) {
                var columnHeaders = packingMaster.ColumnHeaders || [];
                var rows = packingMaster.Rows || [];
                var colCount = columnHeaders.length;

                // In StockView breakdown each packing master always has rows in this order:
                // 0: Up to previous day, 1: Selected day, 2: TOTAL, 3: NO OF CASES.
                // For Opening Stock, "As On Date" means stock up to and including
                // that date, so we use the TOTAL row as Inward (non-editable).
                var inwardValues = new Array(colCount);
                for (var i = 0; i < colCount; i++) inwardValues[i] = 0;

                var totalRow = null;
                if (rows && rows.length) {
                    for (var r = 0; r < rows.length; r++) {
                        if (rows[r].RowType === 'TOTAL') {
                            totalRow = rows[r];
                            break;
                        }
                    }
                }

                // Fallbacks in case RowType is missing but order is kept
                var sourceRow = totalRow;
                if (!sourceRow && rows && rows.length > 2) sourceRow = rows[2];
                if (!sourceRow && rows && rows.length > 1) sourceRow = rows[1];
                if (!sourceRow && rows && rows.length > 0) sourceRow = rows[0];

                if (sourceRow && sourceRow.Values) {
                    for (var c = 0; c < colCount; c++) {
                        var v = (sourceRow.Values.length > c && sourceRow.Values[c] != null)
                            ? sourceRow.Values[c]
                            : 0;
                        inwardValues[c] = v;
                    }
                }

                var html = '';
                html += '<div class="slab-table-wrapper">';
                html += '<table class="slab-table">';
                html += '<thead><tr>';
                html += '<th>Particulars</th>';
                for (var h = 0; h < colCount; h++) {
                    html += '<th>' + columnHeaders[h] + '</th>';
                }
                html += '</tr></thead><tbody>';

                var rowDefs = [
                    { key: 'opening', label: 'Opening', css: '' },
                    { key: 'inward', label: 'Inward', css: '' },
                    { key: 'issued', label: 'Issued', css: 'total-row' },
                    { key: 'closing', label: 'Closing', css: 'no-of-cases-row' }
                ];

                for (var rd = 0; rd < rowDefs.length; rd++) {
                    var def = rowDefs[rd];
                    html += '<tr class="' + def.css + '">';
                    html += '<td class="particulars-cell">' + def.label + '</td>';

                    for (var c = 0; c < colCount; c++) {
                        var cellVal = 0;
                        if (def.key === 'inward') {
                            cellVal = inwardValues[c] || 0;
                        }

                        var display = cellVal > 0 ? formatNumber(cellVal) : '';
                        var readOnlyAttr = (def.key === 'inward' || def.key === 'closing') ? ' readonly' : '';
                        var inputClass = 'slab-input slab-' + def.key;

                        // Opening and Issued should accept only numeric input
                        var inputType = (def.key === 'opening' || def.key === 'issued') ? 'number' : 'text';
                        var extraAttrs = '';
                        if (inputType === 'number') {
                            extraAttrs = ' step="any" min="0"';
                        }

                        html += '<td><input type="' + inputType + '" class="' + inputClass + '" data-row="' + def.key + '" data-col="' + c + '" value="' + display + '"' + readOnlyAttr + extraAttrs + ' /></td>';
                    }

                    html += '</tr>';
                }

                html += '</tbody></table></div>';
                $('#slabTableContainer').html(html);

                // Store column count for calculations and wire events
                $('#slabTableContainer').data('colCount', colCount);
                attachSlabEvents();
                recalcClosing();
            }

            function parseNumber(val) {
                if (val === null || val === undefined) return 0;
                var s = ('' + val).replace(/,/g, '').trim();
                if (s === '') return 0;
                var n = parseFloat(s);
                return isNaN(n) ? 0 : n;
            }

            function formatNumber(n) {
                if (!n || isNaN(n)) return '';
                if (Math.abs(n % 1) < 0.0000001) {
                    return n.toString();
                }
                return n.toFixed(2).replace(/\.00$/, '');
            }

            function recalcClosing() {
                var colCount = $('#slabTableContainer').data('colCount') || 0;

                for (var c = 0; c < colCount; c++) {
                    var o = parseNumber($('input.slab-opening[data-col="' + c + '"]').val());
                    var i = parseNumber($('input.slab-inward[data-col="' + c + '"]').val());
                    var iss = parseNumber($('input.slab-issued[data-col="' + c + '"]').val());

                    var clos = o + i - iss;

                    $('input.slab-closing[data-col="' + c + '"]').val(clos !== 0 ? formatNumber(clos) : '');
                }
            }

            function attachSlabEvents() {
                // Rebind to avoid duplicate handlers when table re-renders
                $(document).off('input.slab-calc change.slab-calc', '.slab-opening, .slab-issued');
                $(document).on('input.slab-calc change.slab-calc', '.slab-opening, .slab-issued', function () {
                    recalcClosing();
                });
            }

            $('#asOnDate, #product, #packing').on('change', function () {
                tryRenderTable();
            });
        });
    </script>
}
