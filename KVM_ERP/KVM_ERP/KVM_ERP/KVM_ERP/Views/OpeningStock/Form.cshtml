@model KVM_ERP.Models.TransactionMaster
@{
    ViewBag.Title = "Opening Stock - Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var materialGroups = ViewBag.MaterialGroups as List<System.Web.Mvc.SelectListItem> ?? new List<System.Web.Mvc.SelectListItem>();
    var gradeList = ViewBag.Grades as List<System.Web.Mvc.SelectListItem> ?? new List<System.Web.Mvc.SelectListItem>();
    var colourList = ViewBag.ProductionColours as List<System.Web.Mvc.SelectListItem> ?? new List<System.Web.Mvc.SelectListItem>();
    var receivedTypes = ViewBag.ReceivedTypes as List<System.Web.Mvc.SelectListItem> ?? new List<System.Web.Mvc.SelectListItem>();
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .main-container { background: white; min-height: 100vh; padding: 20px 0; }
    .form-container { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,.1); margin: 20px; overflow: hidden; border: 1px solid #e9ecef; }
    .form-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px 30px; border-radius: 15px 15px 0 0; }
    .form-title { font-size: 28px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 15px; }
    .form-body { padding: 30px; background: white; }
    .form-group { margin-bottom: 18px; }
    .control-label { font-weight: 600; color: #2d3436; margin-bottom: 8px; display: block; }
    .form-control { border: 2px solid #e9ecef; border-radius: 8px; padding: 10px 12px; font-size: 14px; background: #f8f9fa; }
    .form-control:focus { border-color: #4facfe; box-shadow: 0 0 0 0.2rem rgba(79,172,254,.25); background: white; }

    .select2-container { width: 100% !important; }
    .select2-container--default .select2-selection--single {
        height: 42px; border: 2px solid #e9ecef; border-radius: 8px; background: #f8f9fa;
        display: flex; align-items: center; padding: 0 12px; transition: all 0.3s ease;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 38px; font-size: 14px; padding-left: 0;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 38px; right: 10px; }

    .table-section { margin-top: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
    .table-section-title { margin-bottom: 15px; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 10px; }

    .slab-table-wrapper { overflow-x: auto; }
    .slab-table { border-collapse: collapse; width: 100%; font-size: 12px; }
    .slab-table thead th {
        background: #7f88e9; color: #fff; padding: 8px; border: 1px solid #6c75d3; text-align: center; white-space: nowrap;
    }
    .slab-table tbody td { padding: 6px; border: 1px solid #dee2e6; text-align: center; }
    .slab-table tbody tr.total-row { background: #d4edda; font-weight: 600; }
    .slab-table tbody tr.no-of-cases-row { background: #fff3cd; font-weight: 600; }
    .slab-table tbody td.particulars-cell { text-align: left; font-weight: 600; }
    .slab-input {
        width: 100%;
        box-sizing: border-box;
        padding: 2px 4px;
        font-size: 11px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        text-align: right;
    }
</style>

<div class="main-container">
    <div class="form-container">
        <div class="form-header">
            <h1 class="form-title">
                <i class="fa fa-play-circle"></i>
                Opening Stock
            </h1>
        </div>
        <div class="form-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Date <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.TRANDATE, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", id = "asOnDate", required = "required" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Product Type <span class="text-danger">*</span></label>
                        @Html.DropDownList("ProductTypeId", materialGroups, "-- Select Product Type --", new { @class = "form-control select2", id = "productType", required = "required" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Packing <span class="text-danger">*</span></label>
                        <select id="packing" class="form-control select2" required>
                            <option value="">-- Select Packing --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Grade <span class="text-danger">*</span></label>
                        @Html.DropDownList("GradeId", gradeList, "-- Select Grade --", new { @class = "form-control select2", id = "grade", required = "required" })
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Production Colour <span class="text-danger">*</span></label>
                        @Html.DropDownList("ProductionColourId", colourList, "-- Select Colour --", new { @class = "form-control select2", id = "productionColour", required = "required" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Received Type <span class="text-danger">*</span></label>
                        @Html.DropDownList("ReceivedTypeId", receivedTypes, "-- Select Received Type --", new { @class = "form-control select2", id = "receivedType", required = "required" })
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Packing Weight with Glazing <span class="text-danger">*</span></label>
                        <input id="packingWeight" type="number" class="form-control" step="0.001" min="0" required />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">No of Slabs <span class="text-danger">*</span></label>
                        <input id="noOfSlabs" type="number" class="form-control" step="1" min="0" required />
                    </div>
                </div>
            </div>

            <div class="table-section">
                <div class="table-section-title">
                    <i class="fa fa-table"></i> Opening Stock Summary
                </div>
                <div class="loading-spinner" id="openingLoadingSpinner" style="display:none; text-align:center; padding:1rem;">
                    <div class="spinner" style="border:4px solid #f3f3f3;border-top:4px solid #4facfe;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 0.5rem;"></div>
                    <p>Loading opening stock...</p>
                </div>
                <table id="openingStockSummary" class="display table table-striped" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th style="text-align:center;">S.No</th>
                            <th style="text-align:left;">Item</th>
                            <th style="text-align:left;">Total</th>
                            <th style="text-align:left;">Cases</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th style="text-align:center;">S.No</th>
                            <th style="text-align:left;">Item</th>
                            <th style="text-align:left;">Total</th>
                            <th style="text-align:left;">Cases</th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="form-group text-center" style="margin-top: 25px;">
                <a href="@Url.Action("Index", "OpeningStock")" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        var openingStockTable = null;
        var osProductGroupMap = @Html.Raw(System.Web.Helpers.Json.Encode(ViewBag.ProductGroupMap));

        function osFormatNumber(value, decimalPlaces) {
            if (value === null || value === undefined || value === '') {
                return '';
            }

            var strValue = value.toString().replace(/,/g, '');
            var num = parseFloat(strValue);
            if (isNaN(num)) {
                return '';
            }
            if (Math.floor(num) === num) {
                return num.toString();
            }
            decimalPlaces = (typeof decimalPlaces === 'number') ? decimalPlaces : 2;
            var str = num.toFixed(decimalPlaces);
            str = str.replace(/(\.\d*?[1-9])0+$/, '$1').replace(/\.0+$/, '').replace(/\.$/, '');
            return str;
        }

        function osShowLoading() {
            $('#openingLoadingSpinner').show();
            $('#openingStockSummary').hide();
        }

        function osHideLoading() {
            $('#openingLoadingSpinner').hide();
            $('#openingStockSummary').show();
        }

        function osReloadSummary() {
            var asOn = $('#asOnDate').val();
            var groupId = $('#productType').val();
            var packingId = $('#packing').val();
            var gradeId = $('#grade').val();
            var colourId = $('#productionColour').val();
            var receivedType = $('#receivedType').val();
            var packingWeight = $('#packingWeight').val();
            var noOfSlabs = $('#noOfSlabs').val();

            if (!asOn || !groupId || !packingId || !gradeId || !colourId || !receivedType || !packingWeight || !noOfSlabs) {
                if (openingStockTable) {
                    openingStockTable.clear().draw();
                }
                return;
            }

            osShowLoading();

            $.ajax({
                url: '@Url.Action("GetAjaxData", "StockView")',
                type: 'POST',
                data: {
                    asOnDate: asOn
                },
                success: function (response) {
                    osHideLoading();

                    var data = (response && response.data) ? response.data : [];

                    // Filter items by selected Product Type (Material Group)
                    if (osProductGroupMap && groupId) {
                        var gid = parseInt(groupId, 10);
                        data = $.grep(data, function (row) {
                            var itemId = row && row.length > 0 ? row[0] : null;
                            if (itemId === null || itemId === undefined) return false;
                            var mapped = osProductGroupMap[itemId];
                            return mapped === gid;
                        });
                    }

                    if (!openingStockTable) {
                        openingStockTable = $('#openingStockSummary').DataTable({
                            data: data,
                            destroy: true,
                            columns: [
                                {
                                    data: null,
                                    orderable: false,
                                    searchable: false,
                                    width: '10%',
                                    className: 'text-center',
                                    render: function (data, type, row, meta) {
                                        return meta.row + 1;
                                    }
                                },
                                {
                                    data: 1,
                                    width: '55%',
                                    render: function (data) {
                                        return '<span>' + data + '</span>';
                                    }
                                },
                                {
                                    data: 2,
                                    width: '20%',
                                    render: function (data) {
                                        var display = osFormatNumber(data);
                                        return '<span style="font-weight:600;color:#28a745;">' + display + ' SLAB</span>';
                                    }
                                },
                                {
                                    data: 3,
                                    width: '15%',
                                    render: function (data) {
                                        var display = osFormatNumber(data);
                                        return '<span style="font-weight:600;color:#28a745;">' + display + ' CASES</span>';
                                    }
                                }
                            ],
                            pageLength: 10,
                            lengthMenu: [[10, 25, 50], [10, 25, 50]],
                            language: {
                                search: 'Search Items:',
                                lengthMenu: 'Show _MENU_ items per page',
                                info: 'Showing _START_ to _END_ of _TOTAL_ items',
                                emptyTable: 'No stock data available'
                            },
                            responsive: true,
                            autoWidth: false
                        });
                    } else {
                        openingStockTable.clear();
                        openingStockTable.rows.add(data);
                        openingStockTable.draw();
                    }
                },
                error: function (xhr, status, error) {
                    osHideLoading();
                    alert('Error loading opening stock summary: ' + error);
                }
            });
        }

        $(document).ready(function () {
            $('.select2').select2({
                placeholder: '-- Select --',
                allowClear: true,
                width: '100%'
            });

            $('#productType').on('change', function () {
                var groupId = $(this).val();

                $('#packing').empty().append('<option value="">-- Select Packing --</option>');
                $('#grade').val('').trigger('change');
                $('#productionColour').val('').trigger('change');
                $('#receivedType').val('').trigger('change');
                // Clear numeric inputs for Packing Weight with Glazing and No of Slabs
                $('#packingWeight').val('');
                $('#noOfSlabs').val('');

                if (!groupId) {
                    if (openingStockTable) {
                        openingStockTable.clear().draw();
                    }
                    return;
                }

                $.getJSON('@Url.Action("GetPackingMasters", "OpeningStock")', { groupId: groupId })
                    .done(function (list) {
                        $.each(list, function (_, item) {
                            $('#packing').append('<option value="' + item.id + '">' + item.text + '</option>');
                        });
                        $('#packing').trigger('change.select2');
                    });

                $.getJSON('@Url.Action("GetFilterValues", "OpeningStock")', { groupId: groupId, asOnDate: $('#asOnDate').val() })
                    .done(function (data) {
                        // Optionally pre-fill numeric inputs using backend-calculated values
                        // while still allowing the user to override.
                        if (data && data.packingWeights && data.packingWeights.length > 0) {
                            $('#packingWeight').val(data.packingWeights[0].value);
                        }

                        if (data && data.noOfSlabs && data.noOfSlabs.length > 0) {
                            $('#noOfSlabs').val(data.noOfSlabs[0].value);
                        }
                    });
            });

            $('#asOnDate, #packing, #grade, #productionColour, #receivedType, #packingWeight, #noOfSlabs').on('change', function () {
                osReloadSummary();
            });
        });
    </script>
}
